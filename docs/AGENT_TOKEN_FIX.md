# Agent Token Generation Fix

## The Problem

The ConvoAI agent was joining the RTC channel **without a token** (empty string `""`), which would cause authentication failures or prevent the agent from properly joining the channel.

Additionally, agent tokens should have a **longer validity period** than user tokens since the agent may be running for extended periods across multiple games.

## The Solution

### 1. Token Generation for Agent

Added automatic **unified token generation** for the ConvoAI agent in `netlify/functions/convoai-agent.js`:

```javascript
function generateAgentToken(channelName, agentUid) {
  const appId = process.env.AGORA_APP_ID;
  const appCertificate = process.env.AGORA_APP_CERTIFICATE;
  
  // Agent token valid for 24 hours (vs 1 hour for users)
  const agentTokenValiditySeconds = parseInt(
    process.env.AGENT_TOKEN_VALIDITY_SECONDS || '86400', 
    10
  );
  
  const tokenExpire = Math.floor(Date.now() / 1000) + agentTokenValiditySeconds;
  const privilegeExpire = 0; // 0 means same as tokenExpire
  
  // Generate unified RTC+RTM token using buildTokenWithRtm (synchronous)
  // This creates a single "007" token that works for both RTC and RTM
  const token = RtcTokenBuilder.buildTokenWithRtm(
    appId,
    appCertificate,
    channelName,
    agentUid.toString(),
    RtcRole.PUBLISHER,
    tokenExpire,
    privilegeExpire
  );
  
  return token; // Single token for both RTC and RTM
}
```

**Note:** This uses `buildTokenWithRtm` which creates a **single unified token** (with "007" prefix) that works for both RTC and RTM, matching the `../convo_ai` demo and modern Agora SDK patterns.

See **[UNIFIED_TOKEN_FIX.md](UNIFIED_TOKEN_FIX.md)** for complete details on the unified token approach.

### 2. Longer Token Validity

**User Tokens:**
- Default: 3600 seconds (1 hour)
- Controlled by: `BINGO_TOKEN_VALIDITY_SECONDS`
- Use case: Single game session

**Agent Tokens:**
- Default: 86400 seconds (24 hours)
- Controlled by: `AGENT_TOKEN_VALIDITY_SECONDS`
- Use case: Multiple games, continuous operation

### 3. Automatic UID Assignment

If no agent UID is provided by the client, the backend now automatically generates one:

```javascript
const agentRtcUid = clientConfig?.properties?.agent_rtc_uid || Math.floor(Math.random() * 1000000);
const agentRtmUid = clientConfig?.properties?.agent_rtm_uid || agentRtcUid;
```

This ensures the agent always has a valid UID for both RTC and RTM.

## Configuration

### Environment Variables

Add to your `.env` file:

```bash
# Required for token generation
AGORA_APP_ID=your_app_id
AGORA_APP_CERTIFICATE=your_app_certificate

# Optional: Agent token validity (default: 24 hours)
AGENT_TOKEN_VALIDITY_SECONDS=86400

# User token validity for comparison (default: 1 hour)
BINGO_TOKEN_VALIDITY_SECONDS=3600
```

### Recommended Token Durations

| Use Case | Duration | Reason |
|----------|----------|--------|
| **User Tokens** | 1 hour (3600s) | Typical game session length |
| **Agent Tokens** | 24 hours (86400s) | Agent persists across multiple games |
| **Development** | 1 hour for both | Easier to test token renewal |
| **Production** | 24 hours for agent, 1 hour for users | Balance security and convenience |

## How It Works

### Before (Broken)
```json
{
  "properties": {
    "channel": "bingo_ABC123",
    "token": "",  // ‚ùå Empty token!
    "agent_rtc_uid": "123456",
    ...
  }
}
```

**Result:** Agent could not authenticate or join the RTC channel properly.

### After (Fixed)
```json
{
  "properties": {
    "channel": "bingo_ABC123",
    "token": "006abc123...xyz789",  // ‚úÖ Valid 24-hour token
    "agent_rtc_uid": "123456",
    ...
  }
}
```

**Result:** Agent joins successfully with proper authentication.

## Logging

When the agent token is generated, you'll see:

```
Generated unified token (007) for agent UID 956240 in channel bingo_ABC123, valid for 86400s
Agent unified token generated: {
  channel: 'bingo_ABC123',
  rtcUid: 956240,
  rtmUid: 956240,
  hasToken: true,
  tokenPrefix: '007'
}
```

This confirms:
- ‚úÖ Unified token was generated with "007" prefix
- ‚úÖ Single token works for both RTC and RTM
- ‚úÖ Channel name is correct
- ‚úÖ Agent RTC and RTM UIDs are assigned (same UID for both)
- ‚úÖ Token validity period (24 hours by default)

## Token Comparison

### Consistent Token Generation Pattern

Both users and agents use the **same token generation pattern** (matching the `../convo_ai` demo):

| Entity | RTC Token | RTM Token | Validity | Generated By |
|--------|-----------|-----------|----------|--------------|
| **User** | ‚úÖ Yes | ‚úÖ Yes | 1 hour | `generate-token.js` |
| **Agent** | ‚úÖ Yes | ‚úÖ Yes | 24 hours | `convoai-agent.js` |

**Why both tokens?**
- **RTC Token:** Required for joining the voice channel
- **RTM Token:** Required for real-time messaging (game state, chat)
- Both use the **same UID** and **same expiration time** for consistency

### User Token Flow
1. User requests to join game
2. Frontend calls `/.netlify/functions/generate-token`
3. Backend generates **RTC + RTM tokens** (1-hour validity)
4. User joins RTC channel with RTC token
5. User joins RTM channel with RTM token
6. Tokens expire after 1 hour
7. Frontend requests token renewal if game continues

### Agent Token Flow
1. Game triggers number announcement
2. Frontend calls `/.netlify/functions/convoai-agent` with action: 'start'
3. Backend generates **RTC + RTM tokens** (24-hour validity) **automatically**
4. Agent joins RTC channel with RTC token
5. Agent uses RTM for communication
6. Agent speaks and leaves
7. Tokens remain valid for next announcement (no renewal needed for 24 hours)

## Benefits

### 1. Automatic Token Management
No need to pass tokens from the frontend - the backend handles it all.

### 2. Longer Validity for Agents
Agents don't need frequent token renewals since they're not user-facing sessions.

### 3. Security
- User tokens expire quickly (1 hour)
- Agent tokens are generated server-side only
- App Certificate never exposed to frontend

### 4. Reliability
Agent can participate in multiple games without token expiration issues.

## Troubleshooting

### "Invalid token" errors for agent

**Check:**
1. `AGORA_APP_CERTIFICATE` is set correctly in `.env`
2. App Certificate matches what's in Agora Console
3. Certificate is enabled in your Agora project

**Verify:**
```bash
# Check if App Certificate is set
grep AGORA_APP_CERTIFICATE .env
```

### Agent joins but immediately leaves

This is likely a **token issue**. Check the logs for:
```
Generated agent token for channel...
```

If you don't see this log, the token generation failed.

### Token expires during long games

**For users:**
- Normal behavior - tokens should expire and renew
- Check `BINGO_TOKEN_VALIDITY_SECONDS` and renewal logic

**For agents:**
- Shouldn't happen with default 24-hour validity
- Increase `AGENT_TOKEN_VALIDITY_SECONDS` if needed
- Example: `AGENT_TOKEN_VALIDITY_SECONDS=172800` (48 hours)

### Different agent UID each time

**If you want consistent agent UID:**

Pass it explicitly in the frontend:

```javascript
const agentConfig = {
  properties: {
    agent_rtc_uid: '999999',  // Fixed UID
    agent_rtm_uid: '999999'
  }
};
```

**If you want random UID (current behavior):**

Don't pass the UID - backend auto-generates it. This is fine for most use cases.

## Testing

### 1. Verify Token Generation

Create a game and trigger agent announcement. Check terminal logs for:

```
Generated agent token for channel bingo_VW72HE, UID 956240, valid for 86400s
```

### 2. Verify Token in Request

Check the full agent config log - the `token` field should be populated:

```json
{
  "properties": {
    "token": "006abc123...xyz789",  // Should have a long token string
    ...
  }
}
```

### 3. Test Agent Joining

Listen for the agent's voice announcement. If you hear it, the token is working!

### 4. Test Token Expiry (Optional)

Set a very short token validity for testing:

```bash
AGENT_TOKEN_VALIDITY_SECONDS=60  # 1 minute
```

Create a game, wait 2 minutes, trigger announcement. Agent should fail to join (token expired).

Then restore the proper value:

```bash
AGENT_TOKEN_VALIDITY_SECONDS=86400  # 24 hours
```

## Implementation Details

### Files Changed

1. **`netlify/functions/convoai-agent.js`**
   - Added `generateAgentToken()` function
   - Imported `RtcTokenBuilder` from `agora-access-token`
   - Generate token before building agent config
   - Auto-assign agent UID if not provided

2. **`env.example`**
   - Added `AGENT_TOKEN_VALIDITY_SECONDS` with default 86400

### Code Structure

```javascript
// 1. Import token builder
const { RtcTokenBuilder, RtcRole } = require('agora-access-token');

// 2. Generate token function
function generateAgentToken(channelName, agentUid) { ... }

// 3. In 'start' action handler:
const agentRtcUid = clientConfig?.properties?.agent_rtc_uid || Math.floor(Math.random() * 1000000);
const agentToken = generateAgentToken(agentChannel, agentRtcUid);

// 4. Use in agent config:
const agentConfig = {
  properties: {
    token: agentToken,  // ‚úÖ Now has valid token
    agent_rtc_uid: agentRtcUid,
    ...
  }
};
```

## Security Considerations

### ‚úÖ Good Practices
- Tokens generated server-side only
- App Certificate never sent to frontend
- Agent tokens expire (just later than user tokens)
- Token validity configurable per environment

### ‚ö†Ô∏è Considerations
- 24-hour tokens are longer-lived (trade-off for convenience)
- Agent UID may be predictable if using fixed values
- Token appears in server logs (consider log sanitization in production)

### üîí Recommendations
- Keep `AGORA_APP_CERTIFICATE` secret
- Use shorter validity in development for testing
- Monitor agent token usage in production
- Rotate App Certificate periodically

## Summary

‚úÖ **Agent now gets a unified token** with "007" prefix  
‚úÖ **Single token works for both RTC and RTM**  
‚úÖ **Uses `buildTokenWithRtm`** (modern Agora standard)  
‚úÖ **Matches the token pattern from `../convo_ai` demo**  
‚úÖ **Token validity: 24 hours for agent (configurable), 1 hour for users**  
‚úÖ **Automatic UID assignment**  
‚úÖ **Server-side token generation**  
‚úÖ **Proper logging for debugging**  
‚úÖ **Consistent with user token generation**  

The ConvoAI agent can now successfully join the RTC channel and use RTM with proper authentication! üéâ

### Token Generation Consistency

Both functions (`generate-token.js` for users and `convoai-agent.js` for agents) now:
1. Use **`buildTokenWithRtm`** to generate a unified token
2. Return a **single "007" token** that works for both RTC and RTM
3. Use the **same UID** for both RTC and RTM
4. Set the **same expiration time** for all privileges
5. Follow the **same pattern** as the `../convo_ai` reference demo

See **[UNIFIED_TOKEN_FIX.md](UNIFIED_TOKEN_FIX.md)** for complete details on the unified token approach.

